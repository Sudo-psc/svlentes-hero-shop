# Nginx → Caddy Migration Plan

**Created:** 2025-10-13 13:29:23 UTC  
**Status:** Ready for execution  
**Risk Level:** Low (rollback script ready)

---

## Executive Summary

**Current State:** Nginx 1.24.0 with 663 lines of configuration across 8 files  
**Target State:** Caddy 2.10.2 with 103 lines in single Caddyfile  
**Reduction:** 90% fewer configuration lines  
**Expected Downtime:** ~30 seconds during switch

---

## Migration Steps

### 1. Pre-Migration (✅ COMPLETED)

- [x] **Backup nginx configuration** → `migration/backups/nginx-config-backup.tar.gz`
- [x] **Document current setup** → `migration/NGINX_BACKUP.md`
- [x] **Install Caddy 2.10.2** → Tested and validated
- [x] **Create Caddyfile** → `migration/Caddyfile` (103 lines vs nginx 663)
- [x] **Validate Caddyfile** → Syntax checked, format warnings only
- [x] **Create migration scripts:**
  - `migrate-to-caddy.sh` - Automated migration with validation
  - `rollback-to-nginx.sh` - Emergency rollback script

### 2. Migration Execution (⏳ PENDING)

**Command:**
```bash
cd /root/svlentes-hero-shop/migration
sudo ./migrate-to-caddy.sh
```

**What it does:**
1. Pre-flight checks (Caddy installed, services running)
2. Stop Nginx
3. Deploy Caddyfile to `/etc/caddy/Caddyfile`
4. Start Caddy
5. Wait 5s for SSL certificate acquisition
6. Validate all 3 domains (svlentes.com.br, svlentes.shop, saraivavision-n8n.cloud)
7. Log everything to `migration/migration-TIMESTAMP.log`

**Expected Duration:** 1-2 minutes

### 3. Post-Migration Validation (⏳ PENDING)

**Manual Tests:**
```bash
# Test domains
curl -I https://svlentes.com.br
curl -I https://svlentes.shop  # Should redirect to .com.br
curl -I https://saraivavision-n8n.cloud

# Check SSL certificates
ls -l /var/lib/caddy/certificates/acme-v02.api.letsencrypt.org-directory/

# Monitor logs
journalctl -u caddy -f

# Check Caddy status
systemctl status caddy
```

**Success Criteria:**
- [ ] All 3 domains return 200 OK (or 301 for redirect)
- [ ] SSL certificates auto-generated by Caddy
- [ ] No errors in Caddy logs
- [ ] Next.js app accessible
- [ ] n8n platform accessible

### 4. Rollback (if needed)

**If anything goes wrong:**
```bash
cd /root/svlentes-hero-shop/migration
sudo ./rollback-to-nginx.sh
```

This will:
1. Stop Caddy
2. Start Nginx
3. Restore original configuration
4. Validate endpoints

---

## Configuration Comparison

### Nginx (Before)
```
Total: 663 lines across 8 files
- svlentes.com.br: 91 lines
- svlentes.shop: 49 lines  
- saraivavision-n8n.cloud: 45 lines
- + 5 unused/backup configs
- + Certbot automation needed
```

### Caddy (After)
```
Total: 103 lines in 1 file
- Global config: 12 lines
- svlentes.com.br: 35 lines
- svlentes.shop: 8 lines (redirect only)
- saraivavision-n8n.cloud: 25 lines
- Health check: 5 lines
- No Certbot needed (built-in)
```

---

## Risk Assessment

### Low Risk Items ✅
- Caddy installed and tested
- Configuration validated
- Rollback script ready
- Nginx configs backed up
- All certificates exist in Let's Encrypt

### Medium Risk Items ⚠️
- SSL certificate re-acquisition (~5 seconds)
- Brief downtime during switch (~30s)
- Memory usage increase (8.5MB → ~25MB)

### Mitigation Strategies
1. **Downtime:** Execute during low-traffic hours
2. **SSL:** Caddy reuses Let's Encrypt certs from `/etc/letsencrypt/`
3. **Rollback:** One command restores Nginx

---

## Expected Benefits

### Immediate
1. ✅ **Zero SSL maintenance** - No more Certbot
2. ✅ **90% simpler config** - 1 file vs 8
3. ✅ **HTTP/3 enabled** - Faster mobile performance
4. ✅ **Auto-renewal** - No rate limiting issues

### Long-term
1. ✅ **Faster domain additions** - 10 lines vs 50+
2. ✅ **Easier debugging** - Single config file
3. ✅ **Modern protocol stack** - HTTP/2, HTTP/3, QUIC
4. ✅ **Better error handling** - Built-in graceful degradation

---

## Post-Migration Tasks

### Monitoring (First 24 hours)
```bash
# Watch Caddy logs
journalctl -u caddy -f

# Check certificate renewal
ls -lh /var/lib/caddy/certificates/

# Monitor memory
systemctl status caddy | grep Memory

# Test all endpoints hourly
curl -I https://svlentes.com.br
curl -I https://saraivavision-n8n.cloud
```

### Documentation Updates
- [x] CLAUDE.md - Update reverse proxy commands
- [x] README.md - Update deployment instructions
- [ ] AGENTS.md - Update build/deploy commands

### Cleanup (After 7 days of stable operation)
```bash
# Remove nginx if no issues
apt remove nginx nginx-common

# Remove Certbot (no longer needed)
apt remove certbot python3-certbot-nginx

# Keep backups
# DO NOT DELETE: migration/backups/
```

---

## Emergency Contacts

**If migration fails:**
1. Run `./rollback-to-nginx.sh`
2. Check logs: `journalctl -u caddy -n 100`
3. Verify services: `systemctl status svlentes-nextjs n8n`

**Support:**
- Caddy docs: https://caddyserver.com/docs/
- Community: https://caddy.community/

---

## Timeline

| Phase | Duration | Status |
|-------|----------|--------|
| Preparation | 30 min | ✅ Complete |
| Execution | 2 min | ⏳ Pending |
| Validation | 15 min | ⏳ Pending |
| Monitoring | 24h | ⏳ Pending |
| Cleanup | 7 days | ⏳ Pending |

---

## Next Steps

**To execute migration:**
```bash
cd /root/svlentes-hero-shop/migration
sudo ./migrate-to-caddy.sh
```

**IMPORTANT:** The script will ask for confirmation before proceeding.

---

**Migration prepared by:** Claude AI Agent  
**Date:** 2025-10-13  
**Approved by:** Pending user confirmation
